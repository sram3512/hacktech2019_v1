/**
 * Copyright 2017 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

'use strict';

const functions = require('firebase-functions');
const {google} = require('googleapis');
const {WebhookClient} = require('dialogflow-fulfillment');

exports.dialogflowFirebaseFulfillment = functions.https.onRequest((request, response) => {
  const agent = new WebhookClient({ request, response });
  
  
  console.log(agent.intent);
  console.log(agent.query);
  //console.log('Welcome');
  var request2 = require('request');
  //request2('http://www.google.com', function (error, response, body) {
  //console.log('error:', error); // Print the error if one occurred
  //console.log('statusCode:', response && response.statusCode); // Print the response status code if a response was received
  //console.log('body:', body); // Print the HTML for the Google homepage.
  //request2('https://api.dialogflow.com/v1/intents?v=20150910')
  //Contact our server
  var custheader={
    'Content-Type':'application/json'
  };
  var srvour={
	uri: 'http://35.235.111.155:5000/userquery',
    method: 'POST',
    headers: custheader,
    json: {"user_query":agent.query}
  };
  request2(srvour,function(error,response,body){
   console.log(response.StatusCode);
   console.log(body);
  });
  
  var inname_nextid={};
  inname_nextid['hello']='4b601e27-8649-4959-873f-c0a75fdf0675';
  inname_nextid['state1']='df1b0b99-79e3-48a5-9cea-9bdaa60e80f8';
  inname_nextid['state2']='4b601e27-8649-4959-873f-c0a75fdf067';
  
  var state_mapper={};
  state_mapper['hello']='state1';
  state_mapper['state1']='state2';
  state_mapper['state2']='state1';
  
  var headersOpt = {  
    "content-type": "application/json",
    "authorization": "Bearer "
	}; 
  var data ={
  "contexts": [
  ],
  "events": [],
  "fallbackIntent": false,
  "name": state_mapper[agent.intent],
  "priority": 500000,
  "responses": [
    {
      "action": "add.list",
      "affectedContexts": [
      ],
      "defaultResponsePlatforms": {
        "google": true
      },
      "messages": [
        {
          "platform": "google",
          "textToSpeech": "Sorry to hear that. Can I ask you a couple of questions",
          "type": "simple_response"
        },
        {
          "speech": "Sorry to hear that. Can I ask you a couple of questions",
          "type": 0
        }
      ]
    }
  ],
  "templates": [
    "I am under the weather ",
    "Not feeling well",
    "Not so great "
  ],
  "userSays": [
    {
      "count": 0,
      "data": [
        {
          "text": "I am under the weather",
          "userDefined": true
        }
      ]
    },
    {
      "count": 0,
      "data": [
        {
          "text": "Not feeling well"
        }
      ]
    },
    {
      "count": 0,
      "data": [
        {
          "text": "Not so great "
        }
      ]
    }
  ],
  "webhookForSlotFilling": false,
  "webhookUsed": true
  };
  var options = {
  uri: 'https://api.dialogflow.com/v1/intents/'+inname_nextid[agent.intent]+'?v=20150910',
  method: 'PUT',
  headers: headersOpt,
  json: data
 };
  request2(options,function(error,response,body){
   console.log(response.StatusCode);
   console.log(body);
  });
});
